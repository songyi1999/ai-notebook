#!/usr/bin/env bash
# scripts/rebuild_and_prune.sh
# ------------------------------------------------------------
# ç›®çš„: å¼€å‘é˜¶æ®µä¸€é”®é‡å¯ Docker æœåŠ¡å¹¶è‡ªåŠ¨æ¸…ç†æ—§é•œåƒ
# ä½¿ç”¨: bash scripts/rebuild_and_prune.sh
# è¯´æ˜:
#   1. åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨ (--remove-orphans åŒæ—¶ç§»é™¤å­¤ç«‹å®¹å™¨)
#   2. é‡æ–°æ„å»ºé•œåƒå¹¶å¯åŠ¨å®¹å™¨
#   3. åˆ é™¤æ‰€æœ‰ <none> (dangling) é•œåƒ, é˜²æ­¢ç£ç›˜å †ç§¯
# ------------------------------------------------------------
set -euo pipefail

# ç¼–è¯‘å‰ç«¯
echo "ğŸ”¨ ç¼–è¯‘å‰ç«¯..."
cd frontend
npm run build
cd ..




# åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨
echo "â¡ åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨..."
docker-compose down --remove-orphans

# é‡æ–°æ„å»ºå¹¶å¯åŠ¨
echo "ğŸš€ é‡æ–°æ„å»ºå¹¶å¯åŠ¨æœåŠ¡..."
docker-compose up -d --build

# æ¸…ç†æ‚¬æŒ‚é•œåƒ
echo "ğŸ§¹ æ¸…ç†æ‚¬æŒ‚(dangling)é•œåƒ..."
docker image prune -f

echo "âœ… Docker æœåŠ¡å·²é‡å¯ä¸”æ—§é•œåƒå·²æ¸…ç†å®Œæ¯•" 